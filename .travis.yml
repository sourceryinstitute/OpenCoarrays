sudo: false # Use fast containerized linux builds

language: generic

os: # Test on both OS X and Linux
  - linux
  - osx

matrix:
  exclude: # Don't run the "Lint" build on OS X
    - os: osx
      env: BUILD=Lint lMPI=NONE
    - os: linux
      env: BUILD=Release lMPI=openmpi

# Deep clone so we can check things with git,
# C.F. https://github.com/travis-ci/travis-ci/issues/4942
git:
  depth: 500

addons: # Packages needed to bootstrap linuxbrew
  apt:
    packages:
      - gawk
      - build-essential
      - ruby
      - curl

cache: # Use caching on linux container builds
  apt: true
  pip: true
  directories:
    - "$HOME/.cache"
    - "$HOME/.linuxbrew"
    - "$HOME/.cabal"

env:
  matrix:
    - BUILD=CodeCoverage lMPI=mpich
    - BUILD=Release lMPI=mpich
    - BUILD=Release lMPI=openmpi
    - BUILD=Script lMPI=mpich
    - BUILD=Lint lMPI=NONE

before_install:
  - uname
  - source .travis-scripts/set-env.sh # map travis-ci environment to saner variables

install:
  - .travis-scripts/install-phase.sh --build=$BUILD --mpi-lib=${lMPI:-mpich}

script:
  - .travis-scripts/build-phase.sh --build=$BUILD --mpi-lib=${lMPI:-mpich}

after_success: # Upload coverage data and dump logs
  - find . -name '*.gcno' -print
  - gcov-5 --version
  - bash <(curl -s https://codecov.io/bash) -x $(which gcov-5)
  - cat install.log || true

after_failure: # dump logs
  - cat install.log || true

deploy:
  provider: releases # Github releases
  api_key: # encrypted access token `travis encrypt --add deploy.api_key <token>` via travis gem
    secure: m41yBJ5RUgT9M992PwZPbeoNmwsEaYDW3+YRsrbutkJdujnQvoxPd8OSLQkFEIGRiwMSCmW5k7N/01j6caDaYO3EbltoWxbTq0Qb58UEuIfs4XpH7dD5uEcs/QALza5Fx/D9n74JBhLjL1SLRYeh4RCAcbSHPkpSq8uy225R/thRRgSB7iNFjQjIqFPAmNKfAlIYVA0Wd2he6+eQ3M5yRgFJNS1kRU4cb3JlBREHAyy+r6/JKMy5NAOVvRio/PJDuNoTgWFehhRlwYYMw7cXArqV4ubIyoZnyfODf9a1m3nId188BuEi5iWpcnWlTacYGuUmH90YHuUx9kXAfBvNT1k/x8mWqGOcpZqstEzC+L34eRpZY9JwUI3nzdwH4+rrFujdVJwt2jIu8JOYAsbJ5died7qxRjBjLIOEevOcF/JVMKhtFvF8PbYcPl8aYofwjN+ouXbZoYhjnKnoiEfEJH1QYw0paGxZFlAVOcRMHF7dXlBbDTBLdz8zuUojaErKUl5ggiRub65ILG66P9t8yd+uTlZXvpdJ7nQE9v6dCQHkIwhtf59CdthhwxFLU69M1Z/2UAJTCmz7KAM7FwMK+NGvRZpwP4d6VBJIRGM8O6ABt10P/Tjt5RHLopA6N64uw+pq5suNOP/pIGCTKZusaxFtCT8tPM/opX2TRVyYe8M=
  file:
    - "OpenCoarrays-${TRAVIS_TAG}.tar.gz"
    - "opencoarrays-${TRAVIS_TAG}-SHA-256.txt"
  skip_cleanup: true
  on:
    tags: true
    repo: "sourceryinstitute/opencoarrays"
    condition: ("X$BUILD" = "XScript") && ("X$lMPI" = "XMPICH") && ("XTRAVIS_OS_NAME" = "Xlinux")
    # Use release assets generated by the "(install) Script" build

notifications:
  email:
    on_success: change
    on_failure: always
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/93dbafbdf76c1732a623
      - https://webhooks.gitter.im/e/935231573bf1b9f2fe40
    on_success: always  # options: [always|never|change]
    on_failure: always
    on_start: always
  slack:
    secure: o4eh4RSH23T0tSyT2JR1iVNM5piglP1k3+Vtx+KToZPjaLr/Y42pXhoDzLdwAsaHGstNoeCB4lxXo2T3+KD1fHySzHczbFG5Hqt9QcbtuxjJzqFh5kCwkGbk7JS7x46OEggesAtp963zsUI7kRmmz3EmRk082OO+GkVOo17mwHeJK5XxoxwF9AC6hi1dBVd9s6cb9DNuAejVn0UfRcczgSe3dgr9bSczECSwg6EBCfSjIybxEYtAu08iFrWHyWtRtt5FcSPdoXreyw7Jj52LviR0XT4kiPI3vr3yuNVHDX8Fuq2LhG6CaQC3tmlj1Ql2BGi3DpCgAEK1L/e+jyAB0OSxc/gOdPveDhnPxBUqsQqnIGZq+iJ4Bx1HKAqyTgnFhtOvJfvctQL6WBhG7PpGbxsdZ22TcVfXMpW+U7vwKK95VXDe6Hse/7aPu4dxvv9Fk56LbCLoLhUtlxT9PVogQmNTmRxUywKsoOxZS8GLXzjWtNlufCbUtaVDvbuD4OVebgudS02yk1toBi8fmTUKQUnLQE6Wyiy3ZP+yjU7dGoMlNCNGjFkUYPcwXryvOWb/bqmA0EJHiT0T9dmXq8jWAEuq0xXoXZBtOW1ErM8rwxbCwex/MNEMB8YxzujhnPI6dPZVjzLeksAFofCUpGSnACmIHwwH0P4/VVPhKDOAW18=
